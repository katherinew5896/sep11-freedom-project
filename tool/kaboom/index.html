<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" />
        <title>Restaurant Adventure</title>
        <style>
            body {
                background-color: #333;
                overflow: hidden;
                margin: 0;
                padding: 0;
            }
            #menu-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                background-color: rgba(0, 0, 0, 0.7);
            }
            .menu {
                background-color: #f5e7d5;
                padding: 2rem;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
                max-width: 600px;
            }
            .game-title {
                font-size: 3.5rem;
                color: #8b4513;
                margin-bottom: 1.5rem;
                font-weight: bold;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            .btn-start {
                background-color: #8b4513;
                color: white;
                font-size: 1.5rem;
                padding: 0.8rem 2rem;
                border: none;
                border-radius: 10px;
                margin: 1.5rem 0;
                cursor: pointer;
                transition: all 0.3s;
            }
            .btn-start:hover {
                background-color: #a0522d;
                transform: scale(1.05);
            }
            .instructions {
                color: #333;
                font-size: 1.1rem;
                margin-top: 1rem;
                text-align: left;
            }
        </style>
    </head>
    <body>
        <!-- Main Menu -->
        <div id="menu-container">
            <div class="menu">
                <div class="game-title">Restaurant Adventure</div>
                <button id="start-btn" class="btn-start">Start Cooking!</button>
                <div class="instructions">
                    <h4>How to Play:</h4>
                    <ul>
                        <li>Use arrow keys to move your chef around the restaurant</li>
                        <li>Talk to customers to take their orders</li>
                        <li>Go to the kitchen to prepare meals</li>
                        <li>Use the stove, counter, and fridge to cook dishes</li>
                        <li>Press 'E' to interact with objects and customers</li>
                        <li>Serve customers to earn points</li>
                        <li>Switch between dining area and kitchen using the door</li>
                    </ul>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/kaboom@3000.0.1/dist/kaboom.js"></script>
        <script>
            // Initialize Kaboom with larger canvas
            const k = kaboom({
                background: [245, 231, 213], // Creamy restaurant wall color
                width: 2000,  // Increased canvas width
                height: 1000,    // Increased canvas height
                global: false
            });

            // Make Kaboom functions available globally
            const {
                loadSprite,
                scene,
                addLevel,
                rect,
                color,
                area,
                body,
                sprite,
                scale,
                text,
                pos,
                vec2,
                z,
                fixed,
                anchor,
                LEFT,
                RIGHT,
                UP,
                DOWN,
                onKeyPress,
                onKeyDown,
                go,
                height,
                width,
                add,
                destroy,
                loop,
                get,
                onSceneLeave
            } = k;

            // Remove menu and start game when start button is clicked
            document.getElementById("start-btn").addEventListener("click", function() {
                const menuContainer = document.getElementById("menu-container");
                menuContainer.parentNode.removeChild(menuContainer);
                startGame();
            });

            function startGame() {
                // Game variables
                let score = 0;
                let currentOrder = null;
                let holdingItem = null;
                let cookingProgress = 0;
                let currentRecipe = null;
                let cookingTimer = null;

                // Load restaurant-themed sprites
                loadSprite("chef", "sprites/../c.png");
                loadSprite("customer1", "sprites/../c1.png");
                loadSprite("customer2", "sprites/../c3.png");
                loadSprite("table", "sprites/../table.png");
                loadSprite("door", "sprites/../door.png");
                loadSprite("stove", "sprites/../stove.png");
                loadSprite("counter", "sprites/../c4.png");
                loadSprite("fridge", "sprites/../fridge.png");
                loadSprite("plate", "sprites/../plate.png");
                loadSprite("burger", "sprites/../burger.png");
                loadSprite("pizza", "sprites/../pizza.png");
                loadSprite("salad", "sprites/../salad.png");
                loadSprite("steak", "sprites/../steak.png");

                // Define restaurant characters and their dialog
                const characters = {
                    "c": { // Customer 1
                        sprite: "customer1",
                        msg: "I'd like a burger, please!",
                        order: "burger",
                        served: false
                    },
                    "d": { // Customer 2
                        sprite: "customer2",
                        msg: "Can I get a pizza?",
                        order: "pizza",
                        served: false
                    },
                    "e": { // Customer 3
                        sprite: "customer1",
                        msg: "Just a salad for me, thanks!",
                        order: "salad",
                        served: false
                    }
                };

                // Define recipes for dishes
                const recipes = {
                    "burger": {
                        ingredients: ["patty", "bun", "lettuce"],
                        cookTime: 3,
                        points: 10
                    },
                    "pizza": {
                        ingredients: ["dough", "cheese", "tomato"],
                        cookTime: 5,
                        points: 15
                    },
                    "salad": {
                        ingredients: ["lettuce", "tomato", "cucumber"],
                        cookTime: 2,
                        points: 8
                    },
                    "steak": {
                        ingredients: ["beef", "potatoes", "butter"],
                        cookTime: 7,
                        points: 20
                    }
                };

                // Define restaurant areas
                const levels = [
                    // Level 0 - Dining Area
                    [
                        "---------------------",
                        "-                   -",
                        "-  c      d       e -",
                        "-  T      T       T -",
                        "-                   -",
                        "-                   -",
                        "-         @         -",
                        "-                   -",
                        "-                   -",
                        "-  T     T        T -",
                        "-                   -",
                        "-                   -",
                        "---------------------",
                    ],
                    // Level 1 - Kitchen Area
                    [
                        "---------------------",
                        "-                   -",
                        "-  S   C   F        -",
                        "-                   -",
                        "-                   -",
                        "-                   -",
                        "-         @         -",
                        "-                   -",
                        "-                   -",
                        "-                   -",
                        "-                   -",
                        "-                   -",
                        "---------------------",
                    ]
                ];

                // Main game scene
                scene("main", (levelIdx) => {
                    const SPEED = 240;

                    // Create the level
                    const level = addLevel(levels[levelIdx], {
                        tileWidth: 64,
                        tileHeight: 64,
                        pos: vec2(64, 64),
                        tiles: {
                            "-": () => [
                                rect(64, 64),
                                color(139, 69, 19),
                                area(),
                                body({ isStatic: true }),
                            ],
                            "T": () => [
                                sprite("table"),
                                area(),
                                body({ isStatic: true }),
                                "furniture",
                                scale(0.7)
                            ],
                            "@": () => [
                                sprite("chef"),
                                area(),
                                body(),
                                "chef",
                                scale(0.5)
                            ],
                            "S": () => [
                                sprite("stove"),
                                area(),
                                body({ isStatic: true }),
                                "kitchen-equipment",
                                scale(0.6),
                                "stove"
                            ],
                            "C": () => [
                                sprite("counter"),
                                area(),
                                body({ isStatic: true }),
                                "kitchen-equipment",
                                scale(0.6),
                                "counter"
                            ],
                            "F": () => [
                                sprite("fridge"),
                                area(),
                                body({ isStatic: true }),
                                "kitchen-equipment",
                                scale(0.6),
                                "fridge"
                            ]
                        },
                        wildcardTile(ch) {
                            const char = characters[ch];
                            if (char) {
                                return [
                                    sprite(char.sprite),
                                    area(),
                                    body({ isStatic: true }),
                                    "character",
                                    {
                                        msg: char.msg,
                                        order: char.order,
                                        served: char.served,
                                        characterId: ch
                                    },
                                ];
                            }
                        },
                    });

                    const chef = level.get("chef")[0];

                    // Dialog system
                    function addDialog() {
                        const h = 120;
                        const pad = 16;
                        const bg = add([
                            pos(0, height() - h),
                            rect(width(), h),
                            color(0, 0, 0, 200),
                            z(100),
                        ]);
                        const txt = add([
                            text("", {
                                width: width() - pad * 2,
                                size: 18
                            }),
                            pos(pad, height() - h + pad),
                            z(100),
                            color(255, 255, 255),
                        ]);
                        bg.hidden = true;
                        txt.hidden = true;
                        return {
                            say(t) {
                                txt.text = t;
                                bg.hidden = false;
                                txt.hidden = false;
                            },
                            dismiss() {
                                if (!this.active()) return;
                                txt.text = "";
                                bg.hidden = true;
                                txt.hidden = true;
                            },
                            active() {
                                return !bg.hidden;
                            },
                        };
                    }

                    const dialog = addDialog();

                    // Score display
                    const scoreDisplay = add([
                        text(`Score: ${score}`, { size: 24 }),
                        pos(20, 20),
                        color(0, 0, 0),
                        z(50),
                        fixed()
                    ]);

                    // Order display
                    const orderDisplay = add([
                        text("Current Order: None", { size: 24 }),
                        pos(20, 60),
                        color(0, 0, 0),
                        z(50),
                        fixed()
                    ]);

                    // Held item display
                    const heldItemDisplay = add([
                        text("Holding: Nothing", { size: 24 }),
                        pos(20, 100),
                        color(0, 0, 0),
                        z(50),
                        fixed()
                    ]);

                    // Cooking progress display (only in kitchen)
                    const cookingProgressDisplay = levelIdx === 1 ? add([
                        text("", { size: 24 }),
                        pos(width() - 300, 20),
                        color(0, 0, 0),
                        z(50),
                        fixed()
                    ]) : null;

                    function updateHeldItemDisplay() {
                        heldItemDisplay.text = `Holding: ${holdingItem || "Nothing"}`;
                    }

                    function updateOrderDisplay() {
                        orderDisplay.text = `Current Order: ${currentOrder || "None"}`;
                    }

                    function updateCookingProgress() {
                        if (cookingProgressDisplay && currentRecipe) {
                            const progressPercent = Math.floor((cookingProgress / currentRecipe.cookTime) * 100);
                            cookingProgressDisplay.text = `Cooking: ${currentOrder} (${progressPercent}%)`;
                        } else if (cookingProgressDisplay) {
                            cookingProgressDisplay.text = "";
                        }
                    }

// Interact with characters and kitchen equipment
onKeyPress("e", () => {
    if (dialog.active()) {
        dialog.dismiss();
        return;
    }

    // Get all collisions and check for tags in a different way
    const collisions = chef.getCollisions();

    // Check for nearby characters to interact with
    const nearbyChars = collisions.filter(c => {
        // Check if the object has the character data property we added
        return c.characterId && levelIdx === 0;
    });

    if (nearbyChars.length > 0) {
        const char = nearbyChars[0];
        if (!char.served) {
            if (holdingItem && holdingItem === char.order) {
                // Serve the dish
                score += recipes[char.order].points;
                scoreDisplay.text = `Score: ${score}`;
                dialog.say("Thank you! Here's your payment.");
                char.served = true;
                holdingItem = null;
                updateHeldItemDisplay();

                // Remove the served dish
                const plates = get("plate");
                if (plates.length > 0) {
                    destroy(plates[0]);
                }
            } else if (!currentOrder) {
                // Take order
                currentOrder = char.order;
                dialog.say(`Order received: ${char.order}`);
                updateOrderDisplay();
            } else {
                dialog.say("Please complete the current order first!");
            }
        } else {
            dialog.say("Thanks for the great service!");
        }
    }

    // Check for kitchen equipment to interact with
    const nearbyEquipment = collisions.filter(c => {
        // Check for specific equipment tags we added
        return (c.isStove || c.isCounter || c.isFridge) && levelIdx === 1;
    });

    if (nearbyEquipment.length > 0) {
        const equipment = nearbyEquipment[0];

        if (equipment.isFridge) {
            if (!currentOrder) {
                dialog.say("You need to take an order first!");
            } else if (!currentRecipe) {
                currentRecipe = recipes[currentOrder];
                dialog.say(`Got ingredients for ${currentOrder}! Now cook it on the stove.`);
            } else {
                dialog.say("You already have ingredients for the current order.");
            }
        }

        if (equipment.isStove) {
            if (!currentRecipe) {
                dialog.say("You need to get ingredients from the fridge first!");
            } else if (cookingTimer) {
                dialog.say("Already cooking something!");
            } else {
                dialog.say(`Cooking ${currentOrder}... This will take ${currentRecipe.cookTime} seconds.`);

                // Start cooking process
                cookingProgress = 0;
                updateCookingProgress();

                cookingTimer = loop(1, () => {
                    cookingProgress += 1;
                    updateCookingProgress();

                    if (cookingProgress >= currentRecipe.cookTime) {
                        // Cooking complete
                        cookingTimer.cancel();
                        cookingTimer = null;
                        dialog.say(`${currentOrder} is ready! Plate it on the counter.`);
                        holdingItem = currentOrder;
                        updateHeldItemDisplay();
                        currentRecipe = null;
                        updateCookingProgress();
                    }
                });
            }
        }

        if (equipment.isCounter) {
            if (holdingItem) {
                // Create a plate with the food
                add([
                    sprite("plate"),
                    pos(equipment.pos.x + 20, equipment.pos.y - 30),
                    scale(0.5),
                    "plate",
                    {
                        food: holdingItem
                    }
                ]);

                // Add the food sprite on top of the plate
                add([
                    sprite(holdingItem),
                    pos(equipment.pos.x + 20, equipment.pos.y - 30),
                    scale(0.3),
                    z(10)
                ]);

                dialog.say(`Plated ${holdingItem} ready for serving!`);
                holdingItem = null;
                updateHeldItemDisplay();
            } else {
                dialog.say("Nothing to plate. Cook something first!");
            }
        }
    }
});

                    // Door to switch between levels
                    const door = add([
                        rect(64, 32),
                        pos(1000 - 100, height() / 2 + 325),
                        area(),
                        color(139, 69, 19),
                        "door",
                        {
                            targetLevel: levelIdx === 0 ? 1 : 0
                        }
                    ]);

                    // Door label
                    add([
                        text(levelIdx === 0 ? "Kitchen" : "Dining Room", { size: 16 }),
                        pos(1000 - 110, height() / 2 + 370),
                        color(0, 0, 0)
                    ]);

                    chef.onCollide("door", (d) => {
                        // Cancel cooking timer if switching levels
                        if (cookingTimer) {
                            cookingTimer.cancel();
                            cookingTimer = null;
                        }
                        go("main", d.targetLevel);
                    });

                    // Player movement
                    const dirs = {
                        "left": LEFT,
                        "right": RIGHT,
                        "up": UP,
                        "down": DOWN,
                    };
                    for (const dir in dirs) {
                        onKeyPress(dir, () => dialog.dismiss());
                        onKeyDown(dir, () => chef.move(dirs[dir].scale(SPEED)));
                    }

                    // Display area name
                    const areaNames = ["Main Dining Area", "Kitchen"];
                    add([
                        text(areaNames[levelIdx], {
                            size: 32,
                            width: width(),
                        }),
                        pos(width() / 2, 30),
                        anchor("center"),
                        color(139, 69, 19),
                        z(50),
                        fixed()
                    ]);
                });

                // Start the game
                go("main", 0);
            }
        </script>
    </body>
